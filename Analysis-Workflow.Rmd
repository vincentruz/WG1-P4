---
title: "SEISMIC WG1-P4"
author: "Eben"
date: "4/17/2020"
output:
  html_document:
    keep_md: true
    code_folding: show
    theme: cosmo
    toc: yes
    toc_depth: 2
    toc_float: yes
subtitle: Analysis Workflow
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Data Processing (Institution Specific)**
(see [Data Description](https://docs.google.com/spreadsheets/d/1SzU4PcIEUsAGnKKyAcugHO2O2aZW29sf9a_cC-FAElk/edit#gid=1679989021) for shared SEISMIC variable names)

*Note:* 

- Specific syntax for these steps are likely to vary by institutional variable naming conventions
- Sample code shown here; see WG1-P4 GitHub repository institutional folders for complete data cleaning examples.

## 0. Startup

### a.  Load R pkgs
```{r message = FALSE}
if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load("tidyverse")   # Data wrangling
```

### b.	Load full dataset
```{r include = FALSE}
df_full <- read.csv("~/Box Sync/LSAP_LRDC/Research Projects/SEISMIC/AP/SEISMIC_AP/2191_MATH_FULL.csv")
```

```{r eval = FALSE}
# CHANGE TO YOUR FILE PATH
df_full <- read.csv("~/YOUR FILE PATH HERE.csv")
head(names(df_full))
```

```{r echo = FALSE}
head(names(df_full), 15)
```

## 1.	Clean Student level variables

### a. Rename and generate/recode student level variables as needed to match common SEISMIC AP variable names
```{r include = FALSE}
## STABLE - Student Level ####
df_std <- df_full %>%
  # Rename variables
  mutate(st_id = EMPLID_H) %>%
  mutate(firstgen = recode(FIRST_GENERATION_DESCR, "First Generation" = 1, "Not First Generation" = 0, "Unknown" = 0)) %>%
  mutate(ethniccode = ETHNIC_GROUP_CD) %>%
  mutate(ethniccode_cat = recode(ETHNIC_GROUP_CD, "HISPA" = 1, "BLACK" = 1, "AMIND" = 1, "PACIF" = 1, "ASIAN" = 2, "WHITE" = 0)) %>%
  mutate(urm = recode(ETHNIC_GROUP_CD, "HISPA" = 1, "BLACK" = 1, "AMIND" = 1, "PACIF" = 1, "ASIAN" = 0, "WHITE" = 0)) %>%
  mutate(gender = recode(GENDER_CD, "F"=1, "M"=0, "m"=0, "U" = 2)) %>%
  mutate(female = recode(GENDER_CD, "F"=1, "M"=0, "m"=0, "U" = 2)) %>%
  mutate(famincome = abs(AGI)) %>%
  mutate(lowincomflag = if_else(is.na(AGI), 0,
                                if_else(AGI <= 46435, 1,0))) %>%
  mutate(transfer = if_else(TOT_TRNSFR_CREDITS <= 16 | is.na(TOT_TRNSFR_CREDITS), 0, 1)) %>%
  mutate(international = if_else(CITIZENSHIP_STATUS_DESCR == "U.S. Citizen", 0, 1)) %>%
  mutate(ell = if_else(TOEFL_SCORE > 0, 0, 1)) %>%
  mutate(us_hs = if_else(is.na(HS_GPA), 0, 1)) %>%
  separate(as.character("START_TRM_CD"), c("st_YEAR", "st_SEMESTER"), 3, remove = FALSE) %>%
  separate(as.character("st_YEAR"), c("st_DEC", "st_YEAR"), 1) %>%
  mutate(cohort = as.numeric(st_YEAR)) %>%
  mutate(cohort = ifelse(cohort >= 20, cohort + 1900, cohort + 2000)) %>%
  mutate(cohort_2013 = ifelse(cohort == 2013, 1,0)) %>%
  mutate(cohort_2014 = ifelse(cohort == 2014, 1,0)) %>%
  mutate(cohort_2015 = ifelse(cohort == 2015, 1,0)) %>%
  mutate(cohort_2016 = ifelse(cohort == 2016, 1,0)) %>%
  mutate(cohort_2017 = ifelse(cohort == 2017, 1,0)) %>%
  mutate(cohort_2018 = ifelse(cohort == 2018, 1,0)) %>%
  #HACK for apyear (cohort year - 1)
  mutate(apyear = cohort - 1) %>%
  mutate(englsr = if_else(ACT_HIGH_MATH == 36, 800,
                          if_else(ACT_HIGH_MATH == 35, 780,
                                  if_else(ACT_HIGH_MATH == 34, 760,
                                          if_else(ACT_HIGH_MATH == 33, 740,
                                                  if_else(ACT_HIGH_MATH == 32,	720,
                                                          if_else(ACT_HIGH_MATH == 31,	710,
                                                                  if_else(ACT_HIGH_MATH == 30,	700,
                                                                          if_else(ACT_HIGH_MATH == 29,	680,
                                                                                  if_else(ACT_HIGH_MATH == 28,	660,
                                                                                          if_else(ACT_HIGH_MATH == 27,	640,
                                                                                                  if_else(ACT_HIGH_MATH == 26,	610,
                                                                                                          if_else(ACT_HIGH_MATH == 25,	590,
                                                                                                                  if_else(ACT_HIGH_MATH == 24,	580,
                                                                                                                          if_else(ACT_HIGH_MATH == 23,	560,
                                                                                                                                  if_else(ACT_HIGH_MATH == 22,	540,
                                                                                                                                          if_else(ACT_HIGH_MATH == 21,	530,
                                                                                                                                                  if_else(ACT_HIGH_MATH == 20,	520,
                                                                                                                                                          if_else(ACT_HIGH_MATH == 19,	510,
                                                                                                                                                                  if_else(ACT_HIGH_MATH == 18,	500,
                                                                                                                                                                          if_else(ACT_HIGH_MATH == 17,	470,                                                                                                                                                                                                if_else(ACT_HIGH_MATH == 16	, 430,
                                                                                                                                                                                                                                                                                                                                                                                                                   if_else(ACT_HIGH_MATH == 15	, 400,
                                                                                                                                                                                                                                                                                                                                                                                                                           if_else(ACT_HIGH_MATH == 14	, 360,
                                                                                                                                                                                                                                                                                                                                                                                                                                   if_else(ACT_HIGH_MATH == 13	, 330,
                                                                                                                                                                                                                                                                                                                                                                                                                                           if_else(ACT_HIGH_MATH == 12,	310,
                                                                                                                                                                                                                                                                                                                                                                                                                                                   if_else(ACT_HIGH_MATH == 11,	280,
                                                                                                                                                                                                                                                                                                                                                                                                                                                           if_else(ACT_HIGH_MATH == 10,	260, NaN )))))))))))))))))))))))))))) %>%
  mutate(englsr = ifelse(SAT_HIGH_VERBAL %in% NA, englsr, SAT_HIGH_VERBAL)) %>%
  mutate(mathsr = if_else(ACT_HIGH_MATH == 36, 800,
                          if_else(ACT_HIGH_MATH == 35, 780,
                                  if_else(ACT_HIGH_MATH == 34, 760,
                                          if_else(ACT_HIGH_MATH == 33, 740,
                                                  if_else(ACT_HIGH_MATH == 32,	720,
                                                          if_else(ACT_HIGH_MATH == 31,	710,
                                                                  if_else(ACT_HIGH_MATH == 30,	700,
                                                                          if_else(ACT_HIGH_MATH == 29,	680,
                                                                                  if_else(ACT_HIGH_MATH == 28,	660,
                                                                                          if_else(ACT_HIGH_MATH == 27,	640,
                                                                                                  if_else(ACT_HIGH_MATH == 26,	610,
                                                                                                          if_else(ACT_HIGH_MATH == 25,	590,
                                                                                                                  if_else(ACT_HIGH_MATH == 24,	580,
                                                                                                                          if_else(ACT_HIGH_MATH == 23,	560,
                                                                                                                                  if_else(ACT_HIGH_MATH == 22,	540,
                                                                                                                                          if_else(ACT_HIGH_MATH == 21,	530,
                                                                                                                                                  if_else(ACT_HIGH_MATH == 20,	520,
                                                                                                                                                          if_else(ACT_HIGH_MATH == 19,	510,
                                                                                                                                                                  if_else(ACT_HIGH_MATH == 18,	500,
                                                                                                                                                                          if_else(ACT_HIGH_MATH == 17,	470,
                                                                                                                                                                                  if_else(ACT_HIGH_MATH == 16	, 430,
                                                                                                                                                                                          if_else(ACT_HIGH_MATH == 15	, 400,
                                                                                                                                                                                                  if_else(ACT_HIGH_MATH == 14	, 360,
                                                                                                                                                                                                          if_else(ACT_HIGH_MATH == 13	, 330,
                                                                                                                                                                                                                  if_else(ACT_HIGH_MATH == 12,	310,
                                                                                                                                                                                                                          if_else(ACT_HIGH_MATH == 11,	280,
                                                                                                                                                                                                                                  if_else(ACT_HIGH_MATH == 10,	260, NaN )))))))))))))))))))))))))))) %>%
  mutate(mathsr = ifelse(SAT_HIGH_MATH %in% NA, mathsr, SAT_HIGH_MATH)) %>%
  mutate(hsgpa = HS_GPA) %>%
  # Select only common-named variables used in analysis
  select(st_id, firstgen:hsgpa) %>%
  # Remove any duplicate cases
  distinct()
```

```{r eval = FALSE}
## Student Level ####
df_std <- df_full %>%
  # Renamed variables
  mutate(st_id = EMPLID_H) %>%
  mutate(ethniccode = ETHNIC_GROUP_CD) %>%
  mutate(famincome = abs(AGI)) %>%
  # Recoded variables
  mutate(firstgen = recode(FIRST_GENERATION_DESCR, "First Generation" = 1, "Not First Generation" = 0, "Unknown" = 0)) %>%
  mutate(ethniccode_cat = recode(ETHNIC_GROUP_CD, "HISPA" = 1, "BLACK" = 1, "AMIND" = 1, "PACIF" = 1, "ASIAN" = 2, "WHITE" = 0)) %>%
  mutate(urm = recode(ETHNIC_GROUP_CD, "HISPA" = 1, "BLACK" = 1, "AMIND" = 1, "PACIF" = 1, "ASIAN" = 0, "WHITE" = 0)) %>%
  mutate(gender = recode(GENDER_CD, "F"=1, "M"=0, "m"=0, "U" = 2)) %>%
  mutate(female = recode(GENDER_CD, "F"=1, "M"=0, "m"=0, "U" = 2)) %>%
  mutate(lowincomflag = if_else(is.na(AGI), 0,
                                if_else(AGI <= 46435, 1,0))) 

# etc...
```

```{r echo = FALSE}
sample_n(as_tibble(df_std), 10)
```

## 2.	Clean Course level variables

### a.	Rename and generate/recode course level variables as needed to match common SEISMIC AP variable names
```{r include = FALSE}
#### Course Level ####
df_crs <- df_full %>%
  # Rename variables
  mutate(st_id = EMPLID_H) %>%
  mutate(crs_sbj = SUBJECT_CD) %>%
  mutate(crs_catalog = CATALOG_NBR) %>%
  mutate(crs_name	= CLASS_TITLE) %>%
  mutate(numgrade = GRADE_POINTS/UNITS_TAKEN) %>%
  mutate(numgrade_w = if_else(COURSE_GRADE_CD == "W", 1, 0)) %>%
  mutate(crs_retake = REPEAT_CD) %>%
  mutate(crs_term	= TERM_CD) %>%
  separate(as.character("TERM_CD"), c("crs_YEAR", "crs_SEMESTER"), 3, remove = FALSE) %>%
  separate(as.character("crs_YEAR"), c("crs_DEC", "crs_YEAR"), 1) %>% 
  mutate(crs_term_yr = crs_YEAR) %>%
  mutate(crs_term_sem = crs_SEMESTER) %>%
  mutate(summer_crs = if_else(endsWith(as.character(TERM_CD),"7"), 1, 0)) %>%
  mutate(TERM_REF = START_TRM_CD-TERM_CD) %>%
  separate(as.character("START_TRM_CD"), c("st_YEAR", "st_SEMESTER"), 3, remove = FALSE) %>%
  separate(as.character("st_YEAR"), c("st_DEC", "st_YEAR"), 1) %>%
  mutate(enrl_from_cohort = if_else(st_SEMESTER == "1" & TERM_REF == "0", 1,
                                    if_else(TERM_REF == -3, 1.5,
                                            if_else(TERM_REF == -6, 1.66,
                                                    if_else(TERM_REF == -10, 2,
                                                            if_else(TERM_REF == -13, 2.5,
                                                                    if_else(TERM_REF == -16, 2.66,
                                                                            if_else(TERM_REF == -20, 3,
                                                                                    if_else(TERM_REF == -23, 3.5,
                                                                                            if_else(TERM_REF == -26, 3.66,
                                                                                                    if_else(TERM_REF == -30, 4,
                                                                                                            if_else(TERM_REF == -33, 4.5,
                                                                                                                    if_else(TERM_REF == -36, 4.66, 
                                                                                                                            if_else(st_SEMESTER == "4" & TERM_REF == "0", 1,
                                                                                                                                    if_else(TERM_REF == -3, 1.5,
                                                                                                                                            if_else(TERM_REF == -7, 1.66,
                                                                                                                                                    if_else(TERM_REF == -10, 2,
                                                                                                                                                            if_else(TERM_REF == -13, 2.5,
                                                                                                                                                                    if_else(TERM_REF == -17, 2.66,
                                                                                                                                                                            if_else(TERM_REF == -20, 3,
                                                                                                                                                                                    if_else(TERM_REF == -23, 3.5,
                                                                                                                                                                                            if_else(TERM_REF == -27, 3.66,
                                                                                                                                                                                                    if_else(TERM_REF == -30, 4,
                                                                                                                                                                                                            if_else(TERM_REF == -33, 4.5,
                                                                                                                                                                                                                    if_else(TERM_REF == -37, 4.66, 
                                                                                                                                                                                                                            if_else(st_SEMESTER == "7" & TERM_REF == "0", 1,
                                                                                                                                                                                                                                    if_else(TERM_REF == -4, 1.5,
                                                                                                                                                                                                                                            if_else(TERM_REF == -7, 1.66,
                                                                                                                                                                                                                                                    if_else(TERM_REF == -10, 2,
                                                                                                                                                                                                                                                            if_else(TERM_REF == -14, 2.5,
                                                                                                                                                                                                                                                                    if_else(TERM_REF == -17, 2.66,
                                                                                                                                                                                                                                                                            if_else(TERM_REF == -20, 3,
                                                                                                                                                                                                                                                                                    if_else(TERM_REF == -24, 3.5,
                                                                                                                                                                                                                                                                                            if_else(TERM_REF == -26, 3.66,
                                                                                                                                                                                                                                                                                                    if_else(TERM_REF == -30, 4,
                                                                                                                                                                                                                                                                                                            if_else(TERM_REF == -34, 4.5,
                                                                                                                                                                                                                                                                                                                    if_else(TERM_REF == -36, 4.66, NaN ))))))))))))))))))))))))))))))))))))) %>%
  #mutate(gpao = ?) %>%
  #mutate(begin_term_cum_gpa = ?) %>%
  mutate(crs_credits = UNITS_TAKEN) %>%
  #mutate(instructor_name = NA) %>%
  mutate(crs_component= CLASS_COMPONENT_DESCR) %>%
  mutate(class_number	= CLASS_NBR) %>%
  mutate(current_major = ACADEMIC_SUBPLAN_DESCR) %>%
  # Select only common-named variables used in analysis
  select(st_id, crs_sbj:current_major)
```

```{r eval = FALSE}
## Course Level ####
df_crs <- df_full %>%
  # Renamed variables
  mutate(st_id = EMPLID_H) %>%
  mutate(crs_sbj = SUBJECT_CD) %>%
  mutate(crs_catalog = CATALOG_NBR) %>%
  mutate(crs_name	= CLASS_TITLE) %>%
  mutate(crs_retake = REPEAT_CD) %>%
  mutate(crs_term	= TERM_CD) %>%
  # Recoded variables
  mutate(numgrade = GRADE_POINTS/UNITS_TAKEN) %>%
  mutate(numgrade_w = if_else(COURSE_GRADE_CD == "W", 1, 0)) %>%
  separate(as.character("TERM_CD"), c("crs_YEAR", "crs_SEMESTER"), 3, remove = FALSE) %>%
  separate(as.character("crs_YEAR"), c("crs_DEC", "crs_YEAR"), 1) %>% 
  mutate(crs_term_yr = crs_YEAR) %>%
  mutate(crs_term_sem = crs_SEMESTER) %>%
  mutate(summer_crs = if_else(endsWith(as.character(TERM_CD),"7"), 1, 0))

# etc...
```

```{r echo = FALSE}
as_tibble(df_crs)
```

### b.	For each subject course (1 and 2), create dataframe of only first time taking that course
```{r include = FALSE}
# By Course (Taking only First Attempt) ####
# Bio
df_crs_bio1 <- df_crs %>%
  filter(crs_sbj == "BIOSC" & (crs_catalog == "0150")) %>% # | crs_catalog == "0715")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1) 

df_crs_bio2 <- df_crs %>%
  filter(crs_sbj == "BIOSC" & (crs_catalog == "0160")) %>% # | crs_catalog == "0716")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1) 

#Chem
df_crs_chem1 <- df_crs %>%
  filter(crs_sbj == "CHEM" & (crs_catalog == "0110")) %>% # | crs_catalog == "0710")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1) 

df_crs_chem2 <- df_crs %>%
  filter(crs_sbj == "CHEM" & (crs_catalog == "0120")) %>% # | crs_catalog == "0720")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1) 

#Phys
df_crs_phys1 <- df_crs %>%
  filter(crs_sbj == "PHYS" & (crs_catalog == "0174")) %>% # | crs_catalog == "0475")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1)

df_crs_phys2 <- df_crs %>%
  filter(crs_sbj == "PHYS" & (crs_catalog == "0175")) %>% # | crs_catalog == "0476")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1) 
```

```{r eval = FALSE}
# By Course (Taking only First Attempt) ####
# Bio
df_crs_bio1 <- df_crs %>%
  filter(crs_sbj == "BIOSC" & (crs_catalog == "0150")) %>% # | crs_catalog == "0715")) %>%
  #Only first time taking course
  group_by(st_id, crs_catalog) %>% 
  arrange(crs_term, .by_group= TRUE) %>%
  mutate(crs_retake_num = row_number()) %>%
  filter(crs_retake_num == 1) 

# repeat for Bio2, Chem1, Chem2, Phys1, Phys2
```

```{r echo = FALSE}
as_tibble(df_crs_bio1)
```

## 3.	Clean AP Level variables

### a.  For each AP subject, rename and generate/recode course level variables as needed to match common SEISMIC AP variable names

*Note:*

- Taking highest (max) AP score each student recieved by subject

``` {r include = FALSE}
##### AP Level ####
# By course ####
# Bio
df_ap_bio <- df_full %>%
  mutate(st_id = EMPLID_H) %>%
  mutate(aptaker = ifelse(is.na(BY), 0, 1)) %>%
  mutate(eligible_to_skip = ifelse(BY >= 4 & !is.na(BY), 1, 0)) %>%
  mutate(eligible_to_skip_2 = ifelse(BY == 5 & !is.na(BY), 1, 0)) %>%
  mutate(tookcourse = ifelse(
    SUBJECT_CD == "BIOSC" & (CATALOG_NBR == "0150") & # | CATALOG_NBR == "0715") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  mutate(tookcourse_2 = ifelse(
    SUBJECT_CD == "BIOSC" & (CATALOG_NBR == "0160") & # | CATALOG_NBR == "0716") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  #mutate(apyear = ?) %>%
  mutate(apscore = as.character(BY)) %>%
  mutate(apscore_full = ifelse(is.na(BY), 0, BY)) %>%
  select(st_id, aptaker:apscore_full) %>%
  group_by(st_id) %>%
  summarize_at(vars(-group_cols()),max)

#Chem
df_ap_chem <- df_full %>%
  mutate(st_id = EMPLID_H) %>%
  mutate(aptaker = ifelse(is.na(CH), 0, 1)) %>%
  mutate(eligible_to_skip = ifelse(CH >= 3 & !is.na(CH), 1, 0)) %>%
  mutate(eligible_to_skip_2 = ifelse(CH == 5 & !is.na(CH), 1, 0)) %>%
  mutate(tookcourse = ifelse(
    SUBJECT_CD == "CHEM" & (CATALOG_NBR == "0110") & # | CATALOG_NBR == "0710") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  mutate(tookcourse_2 = ifelse(
    SUBJECT_CD == "CHEM" & (CATALOG_NBR == "0120") & # | CATALOG_NBR == "0720") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  #mutate(apyear = ?) %>%
  mutate(apscore = as.character(CH)) %>%
  mutate(apscore_full = ifelse(is.na(CH), 0, CH)) %>%
  select(st_id, aptaker:apscore_full) %>%
  group_by(st_id) %>%
  summarize_at(vars(-group_cols()),max)

#Phys
df_ap_phys <- df_full %>%
  mutate(st_id = EMPLID_H) %>%
  mutate(aptaker_CE = ifelse(is.na(PHCE), 0, 1)) %>%
  mutate(aptaker_CM = ifelse(is.na(PHCM), 0, 1)) %>%
  mutate(aptaker = ifelse(aptaker_CE == 1 | aptaker_CM == 1, 1, 0)) %>%
  mutate(apskipperCE = ifelse(PHCE == 5 & !is.na(PHCE), 1, 0)) %>%
  mutate(apskipperCM = ifelse(PHCM == 5  & !is.na(PHCM), 1, 0)) %>%
  mutate(eligible_to_skip = ifelse(apskipperCE == 1 | apskipperCM == 1, 1, 0)) %>%
  mutate(tookcourse = ifelse(
    SUBJECT_CD == "PHYS" & (CATALOG_NBR == "0174") & # | CATALOG_NBR == "0475") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  mutate(tookcourse_2 = ifelse(
    SUBJECT_CD == "PHYS" & (CATALOG_NBR == "0175") & # | CATALOG_NBR == "0476") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  #mutate(apyear = ?) %>%
  mutate(apscore_CE = PHCE) %>%
  mutate(apscore_CM = PHCM) %>%
  mutate(apscore = ifelse(is.na(PHCM), PHCE, PHCM)) %>%
  mutate(apscore = as.character(apscore)) %>%
  mutate(apscore_CE_full = ifelse(is.na(PHCE), 0, PHCE)) %>%
  mutate(apscore_CM_full = ifelse(is.na(PHCM), 0, PHCM)) %>%
  mutate(apscore_full = ifelse(is.na(PHCM), PHCE, PHCM)) %>%
  mutate(apscore_full = ifelse(is.na(apscore_full), 0, apscore_full)) %>%
  select(st_id, aptaker:apscore_full) %>%
  group_by(st_id) %>%
  summarize_at(vars(-group_cols()),max)
```

``` {r eval = FALSE}
##### AP Level ####
# By course ####
# Bio
df_ap_bio <- df_full %>%
  mutate(st_id = EMPLID_H) %>%
  mutate(aptaker = ifelse(is.na(BY), 0, 1)) %>%
  mutate(eligible_to_skip = ifelse(BY >= 4 & !is.na(BY), 1, 0)) %>%
  mutate(eligible_to_skip_2 = ifelse(BY == 5 & !is.na(BY), 1, 0)) %>%
  mutate(tookcourse = ifelse(
    SUBJECT_CD == "BIOSC" & (CATALOG_NBR == "0150") & # | CATALOG_NBR == "0715") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  mutate(tookcourse_2 = ifelse(
    SUBJECT_CD == "BIOSC" & (CATALOG_NBR == "0160") & # | CATALOG_NBR == "0716") & 
      COURSE_GRADE_CD != "W", 1, 0)) %>%
  #mutate(apyear = ?) %>%
  mutate(apscore = as.character(BY)) %>%
  mutate(apscore_full = ifelse(is.na(BY), 0, BY)) %>%
  select(st_id, aptaker:apscore_full) %>%
  group_by(st_id) %>%
  summarize_at(vars(-group_cols()),max)

# repeat for Chem, Phys
```
   
```{r echo = FALSE}
as_tibble(df_ap_bio)
```

## 4. Create stacked dataset

### a.  For each course subject, join previously create dataframes for first time taking Course1, Course2, and AP
- Include new variable: “discipline” as flag for each subject
    + BIO
    + CHEM
    + PHYS
```{r include = FALSE}
#### Create Stacked Dataset #### 
# Bio (N=3090)
df_bio <- df_std %>%
  right_join(df_crs_bio2, by = "st_id") %>%
  full_join(df_crs_bio1, by = "st_id") %>%
  full_join(df_ap_bio, by = "st_id") %>%
  mutate(discipline = "BIO") %>%
  mutate(skipped_course = ifelse(tookcourse == 0 & tookcourse_2 == 1, 1, 0)) %>%
  select(discipline, st_id:hsgpa, crs_sbj.x:current_major.x, crs_sbj.y:current_major.y, 
         aptaker, apscore, apscore_full, eligible_to_skip, 
         tookcourse, tookcourse_2, skipped_course) 

# Chem (N=3019)
df_chem <- df_std %>%
  right_join(df_crs_chem2, by = "st_id") %>%
  full_join(df_crs_chem1, by = "st_id") %>%
  full_join(df_ap_chem, by = "st_id") %>%
  mutate(discipline = "CHEM") %>%
  mutate(skipped_course = ifelse(tookcourse == 0 & tookcourse_2 == 1, 1, 0)) %>%
  select(discipline, st_id:hsgpa, crs_sbj.x:current_major.x, crs_sbj.y:current_major.y, 
         aptaker, apscore, apscore_full, eligible_to_skip, 
         tookcourse, tookcourse_2, skipped_course) 

# Phys (N=1598)
df_phys <- df_std %>%
  right_join(df_crs_phys2, by = "st_id") %>%
  full_join(df_crs_phys1, by = "st_id") %>%
  full_join(df_ap_phys, by = "st_id") %>%
  mutate(discipline = "PHYS") %>%
  mutate(skipped_course = ifelse(tookcourse == 0 & tookcourse_2 == 1, 1, 0)) %>%
  select(discipline, st_id:hsgpa, crs_sbj.x:current_major.x, crs_sbj.y:current_major.y, 
         aptaker, apscore, apscore_full, eligible_to_skip,
         tookcourse, tookcourse_2, skipped_course) 
```

```{r eval = FALSE}
# Bio (N=3090)
df_bio <- df_std %>%
  right_join(df_crs_bio2, by = "st_id") %>%
  full_join(df_crs_bio1, by = "st_id") %>%
  full_join(df_ap_bio, by = "st_id") %>%
  mutate(discipline = "BIO") %>%
  mutate(skipped_course = ifelse(tookcourse == 0 & tookcourse_2 == 1, 1, 0)) %>%
  select(discipline, st_id:hsgpa, crs_sbj.x:current_major.x, crs_sbj.y:current_major.y, 
         aptaker, apscore, apscore_full, eligible_to_skip, 
         tookcourse, tookcourse_2, skipped_course) 

# repeat for Chem, Phys
```

```{r echo = FALSE}
as_tibble(df_bio)
```

### b. Stack all dataframes, with course indicator
```{r}
# Stacked dataframe with Bio, Chem, Phys
df_clean <- rbind(df_bio, df_chem, df_phys)
df_clean <- df_clean %>%
  rename_at(vars(ends_with(".x")), 
            ~(str_replace(., ".x", "_2"))) %>%
  rename_at(vars(ends_with(".y")), 
            ~(str_replace(., ".y", "")))

rm(df_ap_bio, df_ap_chem, df_ap_phys, 
   df_bio, df_chem, df_phys, 
   df_crs_bio1, df_crs_bio2, df_crs_chem1, df_crs_chem2, df_crs_phys1, df_crs_phys2,
   df_crs, df_std)
```

### c. Should end up with something that looks like this [Example Dataset](https://docs.google.com/spreadsheets/d/1Sj5kaFNGUkBhRoOH3cIPm-97UEBZmcFkbKGjzBbKWc0/edit?usp=drive_open&ouid=118183464940790632947).

```{r echo = FALSE}
head(names(df_clean), 15)
```


# **Data Analysis (Same Across Institutions)**

*Note:* 

- Syntax for these steps should be able to be the same for all institutions (once data cleaning steps above are followed)
- Sample code shown here; see shared analysis folder in WG1-P4 GitHub repository for complete analysis code

## 0. Startup

### a.  Load R pkgs
```{r message = FALSE}
if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load("tidyverse",   # Data wrangling
               "epiDisplay")  # Display OR for logistic regressions
```

### b.	Load full dataset
```{r include = FALSE}
df_clean <- read.csv("~/Box Sync/LSAP_LRDC/Research Projects/SEISMIC/AP/SEISMIC_AP/SEISMIC_AP_CLEAN.csv")
```

```{r eval = FALSE}
# CHANGE TO YOUR FILE PATH
df_clean <- read.csv("~/YOUR FILE PATH HERE.csv")
head(names(df_clean))
```

```{r echo = FALSE}
head(names(df_clean), 15)
```

### c. Filter for student level inclusion/exclusion criteria
- Include: 
    + First time freshmen
    + Took course 2
    + Cohort 2013-2018
- Exclude:
    + Transfer students
    + International students
    + Honors
    
``` {r} 
df_clean <- df_clean %>%
  # Include
  filter(transfer == 0) %>%
  filter(tookcourse_2 == 1) %>%
  filter(cohort >= 2013 & cohort <= 2018) %>%
  # Exclude
  filter(international == 0)

```

### d.	Create subset dataframes for each analysis sample

```{r include = FALSE}
# Subset Dataframes #### 
# Bio
# Took 2nd course in sequence
df_bio2 <- df_clean %>%
  subset(discipline == "BIO") %>%
  subset(apyear >= 2013)
# Took AP 
df_BYtakers <- df_bio2 %>%
  subset(aptaker == 1)
# Skip eligible
df_BYeligible<- df_bio2 %>%
  subset(eligible_to_skip == 1)
df_BYeligible.4 <- df_bio2 %>%
  subset(apscore == 4)
df_BYeligible.5 <- df_bio2 %>%
  subset(apscore == 5)

#Chem
# Took 2nd course in sequence
df_chem2 <- df_clean %>%
  subset(discipline == "CHEM") %>%
  subset(apyear >= 2014)
# Took AP 
df_CHtakers <- df_chem2 %>%
  subset(aptaker == 1)
# Skip eligible
df_CHeligible<- df_chem2 %>%
  subset(eligible_to_skip == 1)
df_CHeligible.3 <- df_chem2 %>%
  subset(apscore == 3)
df_CHeligible.4 <- df_chem2 %>%
  subset(apscore == 4)
df_CHeligible.5 <- df_chem2 %>%
  subset(apscore == 5)

#Phys
# Took 2nd course in sequence
df_phys2 <- df_clean %>%
  subset(discipline == "PHYS") %>%
  subset(apyear >= 2015)
# Took AP 
df_PHtakers <- df_phys2 %>%
  subset(aptaker == 1)
# Skip eligible
df_PHeligible<- df_phys2 %>%
  subset(eligible_to_skip == 1)
df_PHeligible.5 <- df_phys2 %>%
  subset(apscore == 5)

```        

1.	For each course: Full Sample, AP taken after test re-design

```{r eval = FALSE}
# Bio
# Took 2nd course in sequence
df_bio2 <- df_clean %>%
  subset(discipline == "BIO") %>%
  subset(apyear >= 2013)

# repeat for Chem, Phys
```

2.	For each course: Took AP

```{r eval = FALSE}   
# Took AP 
df_BYtakers <- df_clean %>%
  subset(discipline == "BIO") %>%
  subset(aptaker == 1)

# repeat for Chem, Phys
```

3. For each course: Recieved a skip-eligible score 

```{r eval = FALSE}
# Skip eligible
df_BYeligible <- df_clean %>%
  subset(discipline == "BIO") %>%
  subset(eligible_to_skip == 1)

# repeat for Chem, Phys
```

4. For each course: Recieved a skip-eligible score (at each eligible score) 

```{r eval = FALSE}
# Skip eligible (at each eligble scores)
df_BYeligible.4 <- df_bio2 %>%
  subset(apscore == 4)
df_BYeligible.5 <- df_bio2 %>%
  subset(apscore == 5)

# Repeat for Chem, Phys
```

## 1.	Run Models (for each Course)
(see [Sample Descriptions](https://docs.google.com/spreadsheets/d/1rN8W_iz1mr7lEzBGfdTZHa45wKOSLiSF8VEpChCPsmE/edit#gid=129222174) for full model specs.)

## RQ1: What student characteristics are associated with student participation and success in AP courses for students enrolled at the selected universities?

## *RQ1a: Who takes AP?*
      
- Sample: Took Course 2 dataframe
- DV: aptaker
- IV: factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
      scale(hsgpa) + scale(mathsr) + scale(englsr)
- COV: factor(cohort) 

```{r include = FALSE}
# Model 1a: Credits ####
#Bio
m1.a_bio <- glm(aptaker ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                 scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(cohort),
               binomial(link = "logit"), df_bio2)
summary(m1.a_bio)
logistic.display(m1.a_bio)

#Chem
m1.a_chem <- glm(aptaker ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                 scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(enrl_from_cohort),
               binomial(link = "logit"), df_chem2)
summary(m1.a_chem)   
logistic.display(m1.a_chem)

#Physics
m1.a_phys <- glm(aptaker ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                 scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(enrl_from_cohort),
               binomial(link = "logit"), df_phys2)
summary(m1.a_phys)
logistic.display(m1.a_phys)

```

```{r eval = FALSE}
# Model 1a: Credits ####
#Bio
m1.a_bio <- glm(aptaker ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                 scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(cohort),
               binomial(link = "logit"), df_bio2)
logistic.display(m1.a_bio)

# Repeat for Chem, Phys
```

```{r echo = FALSE}
print("Model Parameters for RQ1a - Bio")
logistic.display(m1.a_bio)
```

## *RQ1b.* 

- Sample: Took AP dataframe
- DV: apscore
- IV: factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) + 
      scale(hsgpa) + scale(mathsr) + scale(englsr)
- COV: factor(crs_term) 

```{r include = FALSE}
# Model 1b: Score ####
#Bio
m1.b_bio <- lm(scale(apscore) ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(crs_term),
              df_BYtakers)
summary(m1.b_bio)

#Chem
m1.b_chem <- lm(scale(apscore) ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(crs_term), 
              df_CHtakers)
summary(m1.b_chem)   

#Physics
m1.b_phys <- lm(scale(apscore) ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(crs_term), 
              df_PHtakers)
summary(m1.b_phys)   

```

``` {r eval = FALSE}
#Bio
m1.b_bio <- lm(scale(apscore) ~ factor(firstgen) + factor(lowincomflag)  + factor(female) + factor(urm) +
                scale(hsgpa) + scale(mathsr) + scale(englsr) + factor(crs_term),
              df_BYtakers)
summary(m1.b_bio)

```

```{r echo = FALSE}
print("Model Parameters for RQ1b - Bio")
logistic.display(m1.b_bio)

```

## *(Etc…)*
